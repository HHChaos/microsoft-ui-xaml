parameters:
  solutionPath: ''
  nugetConfigPath: ''
  appxPackageDir: '$(build.artifactStagingDirectory)\$(buildConfiguration)\$(buildPlatform)\AppxPackages'
  buildOutputDir: '$(Build.SourcesDirectory)\BuildOutput'
  copyFilesToStaging: false
  publishPath: '$env:Build_ArtifactStagingDirectory'

steps:
  - task: CmdLine@1
    displayName: 'Display build machine environment variables'
    inputs:
      filename: 'set'

  - task: powershell@2
    inputs:
      targetType: filePath
      filePath: build\Install-WindowsSdkISO.ps1
      arguments: 17763
    displayName: 'Install RS5 SDK (17763)'

  - task: NuGetToolInstaller@0
    displayName: 'Use NuGet 4.9.1'
    inputs:
      versionSpec: 4.9.1
        
  - task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
    displayName: 'NuGet restore ${{ parameters.solutionPath }}'
    inputs:
      restoreSolution: ${{ parameters.solutionPath }}
      feedsToUse: config
      nugetConfigPath: ${{ parameters.nugetConfigPath }}

  - task: VSBuild@1
    displayName: 'Build solution ${{ parameters.solutionPath }}'
    inputs:
      solution: ${{ parameters.solutionPath }}
      vsVersion: 15.0
      platform: '$(buildPlatform)'
      configuration: '$(buildConfiguration)'
      msbuildArgs: '/p:AppxPackageDir="${{ parameters.appxPackageDir }}" /p:AppxBundle=Never /p:AppxSymbolPackageEnabled=false'

  - ${{ if eq(parameters.copyFilesToStaging, 'true') }}:
    - task: powershell@2
      displayName: 'Copy files to staging dir'
      inputs:
        targetType: filePath
        filePath: build\CopyFilesToStagingDir.ps1
        arguments: -BuildOutputDir '${{ parameters.buildOutputDir }}' -PublishDir '${{ parameters.publishPath }}' -Platform '$env:buildPlatform' -Configuration '$env:buildConfiguration'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish artifact: drop'
    inputs:
      PathtoPublish: '${{ parameters.publishPath }}'
      artifactName: 'drop'